---
title: "storytelling"
output: html_document
date: "2024-10-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# Carregar bibliotecas necessárias
library(tidyverse)
library(factoextra)
library(colorspace)
library(patchwork)


brazil_full <- readRDS("~/github/biotrade/brazil_full.rds")
top_3_produtos<- c("Food and beverage", "Wood and derived products", "Natural ingredients")

#preparação estatística
dados_pca<-
  brazil_full %>%
  filter(product_label %in% top_3_produtos,
         between(partner,1,1399)) %>%
  summarise(total = sum(us_dollars_at_current_prices_in_thousands),
            .by = c(partner_label, product_label)) %>%
  pivot_wider(names_from = product_label, values_from = total)

dados_pca<- janitor::clean_names(dados_pca)

dados_pca<-
dados_pca %>%
  replace(is.na(.), 0)




# Remover a coluna de países e selecionar apenas colunas numéricas (produtos)
data_numeric <- dados_pca %>%
  select(-1) %>%
  mutate(across(everything(), as.numeric))

# Padronizar os dados (necessário para PCA)
data_scaled <- scale(data_numeric)

# Executar a PCA
pca_result <- prcomp(data_scaled, center = TRUE, scale. = TRUE)

data_scaled <- as_tibble(data_scaled)

data_scaled$partner_label <- dados_pca$partner_label

paises_coordenadas<- as_tibble(pca_result$x)

paises_coordenadas$partner_label<- dados_pca$partner_label

padronizado_relevante<-
data_scaled %>%
  mutate(name = as.character(row_number())) %>%
  filter(food_and_beverage>=0 |
         wood_and_derived_products>=0 |
         natural_ingredients>=0)  %>%
  inner_join(paises_coordenadas)

padronizado_relevante<- janitor::clean_names(padronizado_relevante)

dados_modelo_eua_china_relevante<-
  padronizado_relevante %>%
  mutate(tipo_pais = ifelse(pc2>0, "EUA","China"))



total_pais<-
  brazil_full %>%
  filter(str_length(product) == 3,
         between(partner,1,1399)) %>%
  summarise(total = sum(us_dollars_at_current_prices_in_thousands, na.rm= TRUE),
            .by = c( partner_label))


total_produtos_pais<-
  brazil_full %>%
  filter(str_length(product) == 3,
         between(partner,1,1399)) %>%
  summarise(total_pais = sum(us_dollars_at_current_prices_in_thousands, na.rm = TRUE),
            .by = c(partner_label, product_label)) %>%
  inner_join(total_pais) %>%
  mutate(perc_pais = (total_pais/total)*100)


dados_analise<-
  dados_modelo_eua_china_relevante %>%
  inner_join(total_produtos_pais)



```


```{r fig.height=8, fig.width=11, fig.dpi= 300}
dados_analise %>%
  mutate(product_label = ifelse(product_label %in% top_3_produtos,product_label, "Other products" ) ) %>%
  mutate(product_label = fct_reorder(product_label,total_pais,sum, .desc = TRUE)) %>%
  mutate(partner_label = fct_reorder(partner_label,total_pais,sum)) %>%
  ggplot(aes(y=partner_label, x=perc_pais)) +
  geom_col(aes(fill = product_label))  +
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) +
  facet_wrap(tipo_pais ~.) +
  labs(
    x= "",
    y="",
    fill = "produto"
  )


```

```{r fig.height=8, fig.width=11, fig.dpi= 300}

graf1<-
dados_analise %>%
  filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Natural ingredients") %>%
  mutate(partner_label = reorder(partner_label,perc_pais)) %>%
  ggplot(aes(y=partner_label, x=perc_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 


graf2<-
dados_analise %>%
  filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Natural ingredients") %>%
  mutate(partner_label = reorder(partner_label,total_pais)) %>%
  ggplot(aes(y=partner_label, x=total_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 

graf1 + graf2
```

```{r fig.height=8, fig.width=11, fig.dpi= 300}
graf1<-
dados_analise %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Food and beverage") %>%
  mutate(partner_label = reorder(partner_label,perc_pais)) %>%
  ggplot(aes(y=partner_label, x=perc_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 


graf2<-
dados_analise %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Food and beverage") %>%
  mutate(partner_label = reorder(partner_label,total_pais)) %>%
  ggplot(aes(y=partner_label, x=total_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 

graf1 + graf2
```

```{r fig.height=8, fig.width=11, fig.dpi= 300}
graf1<-
dados_analise %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Wood and derived products") %>%
  mutate(partner_label = reorder(partner_label,perc_pais)) %>%
  ggplot(aes(y=partner_label, x=perc_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 


graf2<-
dados_analise %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Wood and derived products") %>%
  mutate(partner_label = reorder(partner_label,total_pais)) %>%
  ggplot(aes(y=partner_label, x=total_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 

graf1 + graf2
```

```{r fig.height=8, fig.width=11, fig.dpi= 300}
graf1<-
dados_analise %>%
  mutate(product_label = ifelse(product_label %in% top_3_produtos,product_label, "Other products" ) ) %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Other products") %>%
  mutate(partner_label = reorder(partner_label,perc_pais)) %>%
  ggplot(aes(y=partner_label, x=perc_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 


graf2<-
dados_analise %>%
  mutate(product_label = ifelse(product_label %in% top_3_produtos,product_label, "Other products" ) ) %>%
  #filter(!partner_label %in% c("United States of America", "China")) %>%
  filter(product_label == "Other products") %>%
  mutate(partner_label = reorder(partner_label,total_pais)) %>%
  ggplot(aes(y=partner_label, x=total_pais)) +
  geom_col(aes(fill = tipo_pais))+
  scale_fill_discrete_qualitative(palette = "Dark 2") +
  theme_light()+
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "black"),
    strip.background = element_rect(fill =  "black")
  ) 

graf1 + graf2
```

